platform: linux

image_resource:
  type: docker-image
  source: {repository: hashicorp/terraform}

inputs:
  - name: concourse

outputs:
  - name: schema

params:
  - tf_vars:
    - TF_VAR_V1: "secret1qddjehshbalala"
    - TF_VAR_V2: "secret2"
    - TF_VAR_V3: "secret3"
run:
  path: sh
  args:
  - -exc
  - |
    ls
    JQ_URL="https://circle-downloads.s3.amazonaws.com/circleci-images/cache/linux-amd64/jq-latest" 
    curl --silent --show-error --location --fail --retry 3 --output /usr/bin/jq $JQ_URL
    chmod +x /usr/bin/jq
    jq --version
    for obj in $(echo "${tf_vars}" | jq -c '.[]'); do
      TF_VAR="$(echo ${obj} | jq -r "to_entries|map(\"\(.key)=\(.value|tostring)\")|.[]")"
      export $TF_VAR
    done
    terraform plan terraform.tf
    

